name: populate_matrix_from_json

on:
  push:
    branches:
      - main

jobs:
  step1:
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.setup.outputs.matrix }}

    steps:
    - name: Setup
      id: setup
      run: |
        # Create config.json file
        echo '[
          {
            "project": "foo",
            "config": "Debug",
            "nested": [
              {
                "val": "val1"
              }
            ]
          },
          {
            "project": "bar",
            "config": "Release",
            "nested": [
              {
                "val": "val2"
              },
              {
                "val": "val3"
              }
            ]
          }
        ]' > config.json

        # Output matrix
        echo "matrix=$(jq -r -c . < config.json)" >> $GITHUB_ENV
    
    - name: Check
      run: jq . <<< "${{ steps.setup.outputs.matrix }}"

  step2:
    needs: step1

    runs-on: ubuntu-latest

    strategy:
      matrix: 
        include: ${{ fromJSON(needs.step1.outputs.matrix) }}

    steps:
    - name: Check
      env:
        MATRIX: ${{ toJSON(matrix) }}
        PROJECT: ${{ matrix.project }}
        CONFIG: ${{ matrix.config }}
        NESTED: ${{ join(matrix.nested.*.val, ', ') }}
      run: |
        echo "MATRIX: $(jq -r -c '.' <<< "$MATRIX")"
        echo "PROJECT: [$PROJECT]"
        echo "CONFIG: [$CONFIG]"
        echo "NESTED: [$NESTED]"
